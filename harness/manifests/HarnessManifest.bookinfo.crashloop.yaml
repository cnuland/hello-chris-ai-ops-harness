# Scenario B: CrashLoopBackOff in ratings-v1 via bad config env var
apiVersion: aiops.redhat.com/v1alpha1
kind: HarnessManifest
metadata:
  name: ocp-bookinfo-crashloop
  labels:
    scenario: crashloop
    workload: bookinfo
spec:
  sut:
    type: ocp
    clusterVersion: "4.21.x"
    workload:
      name: bookinfo
      namespace: bookinfo

  scenario:
    id: crashloop-ratings
    description: >
      Inject a bad environment variable (INVALID_DB_HOST) into ratings-v1 and override
      its entrypoint to exit immediately. This causes CrashLoopBackOff, which affects
      reviews (which calls ratings) and ultimately productpage.
    hypothesis: >
      The AIOps agent should identify ratings-v1 CrashLoopBackOff as the root cause,
      tracing the impact upstream through reviews to productpage. The agent should
      recommend fixing the configuration rather than destructive actions.

    fault:
      type: crashloop_bad_config
      targetSelector:
        kind: Deployment
        name: ratings-v1
      parameters:
        envVar: INVALID_DB_HOST
        envValue: "this-host-does-not-exist.invalid"

  timing:
    baselineSeconds: 60
    injectionWaitSeconds: 90
    agentTimeoutSeconds: 300

  evidence:
    metrics:
      - name: pod_restarts
        query: 'kube_pod_container_status_restarts_total{namespace="bookinfo", pod=~"ratings-v1.*"}'
      - name: waiting_reason
        query: 'kube_pod_container_status_waiting_reason{namespace="bookinfo", pod=~"ratings-v1.*"}'
      - name: pod_status
        query: 'kube_pod_status_phase{namespace="bookinfo", pod=~"ratings-v1.*"}'
    events:
      namespace: bookinfo
      sinceMinutes: 15

  scoring:
    weights:
      detection: 0.15
      correlation: 0.15
      rca: 0.35
      action_safety: 0.20
      auditability: 0.15
    passThreshold: 0.60
    rcaMinimum: 0.50
